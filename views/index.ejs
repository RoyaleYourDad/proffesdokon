<%- include('partials/header') %>
  <div class="py-8 bg-gray-100">
    <div class="container mx-auto px-4 max-w-7xl">
      <div class="flex flex-col md:flex-row gap-6">
        <!-- Filters -->
        <div class="w-full md:w-80 flex-shrink-0 order-first md:order-first">
          <div class="bg-white shadow-md rounded-xl p-5 md:sticky md:top-20">
            <div class="flex items-center justify-between md:block">
              <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M3 4a1 1 0 011-1h16a1 1 0 011 1m-4 8H3m4 8h14" />
                </svg>
                Filters
              </h2>
              <button id="filter-toggle" class="md:hidden text-blue-600 hover:text-blue-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
              </button>
            </div>
            <form action="/" method="GET" id="filter-form" class="mt-6 hidden md:block">
              <!-- Hidden search input to persist header search -->
              <input type="hidden" name="search"
                value="<%= typeof query.search !== 'undefined' ? query.search : '' %>" />
              <!-- Category Accordion -->
              <details class="mb-3 group" open>
                <summary
                  class="flex items-center justify-between cursor-pointer text-sm font-medium text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-50 transition-all duration-300">
                  <span class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" />
                    </svg>
                    Category
                  </span>
                  <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                <div class="mt-2 space-y-2 px-3 max-h-64 overflow-y-auto transition-all duration-300">
                  <div class="flex items-center">
                    <input type="checkbox" name="category" value="" id="category-all" <%=!query.category ? 'checked'
                      : '' %>
                    class="h-4 w-4 accent-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                    <label for="category-all" class="ml-2 text-sm text-gray-600">All Categories</label>
                  </div>
                  <% categories.slice(0, 5).forEach(category=> { %>
                    <div class="flex items-center">
                      <input type="checkbox" name="category" value="<%= category %>"
                        id="category-<%= category.replace(/\s+/g, '-') %>" <%=query.category===category ? 'checked' : ''
                        %>
                      class="h-4 w-4 accent-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                      <label for="category-<%= category.replace(/\s+/g, '-') %>" class="ml-2 text-sm text-gray-600">
                        <%= category %>
                      </label>
                    </div>
                    <% }) %>
                      <% if (categories.length> 5) { %>
                        <div id="more-categories" class="space-y-2 hidden">
                          <% categories.slice(5).forEach(category=> { %>
                            <div class="flex items-center">
                              <input type="checkbox" name="category" value="<%= category %>"
                                id="category-<%= category.replace(/\s+/g, '-') %>" <%=query.category===category
                                ? 'checked' : '' %>
                              class="h-4 w-4 accent-blue-600 focus:ring-blue-500 border-gray-300 rounded" />
                              <label for="category-<%= category.replace(/\s+/g, '-') %>"
                                class="ml-2 text-sm text-gray-600">
                                <%= category %>
                              </label>
                            </div>
                            <% }) %>
                        </div>
                        <button type="button" id="show-more-categories" aria-expanded="false"
                          class="text-blue-600 hover:underline text-sm font-medium mt-2">
                          Show More
                        </button>
                        <% } %>
                </div>
              </details>
              <!-- Sort By Accordion -->
              <details class="mb-3 group">
                <summary
                  class="flex items-center justify-between cursor-pointer text-sm font-medium text-gray-700 py-2 px-3 rounded-lg hover:bg-gray-50 transition-all duration-300">
                  <span class="flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M3 4h18M3 10h18M3 16h18" />
                    </svg>
                    Sort By
                  </span>
                  <svg class="w-4 h-4 transition-transform group-open:rotate-180" fill="none" stroke="currentColor"
                    viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                  </svg>
                </summary>
                <div class="mt-2 px-3 space-y-2">
                  <label class="flex items-center">
                    <input type="radio" name="sort" value="" <%=!query.sort ? 'checked' : '' %>
                    class="h-4 w-4 accent-blue-600" />
                    <span class="ml-2 text-sm text-gray-600">Default</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="sort" value="price-asc" <%=query.sort==='price-asc' ? 'checked' : '' %>
                    class="h-4 w-4 accent-blue-600" />
                    <span class="ml-2 text-sm text-gray-600">Price: Low to High</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="sort" value="price-desc" <%=query.sort==='price-desc' ? 'checked' : '' %>
                    class="h-4 w-4 accent-blue-600" />
                    <span class="ml-2 text-sm text-gray-600">Price: High to Low</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="sort" value="name-asc" <%=query.sort==='name-asc' ? 'checked' : '' %>
                    class="h-4 w-4 accent-blue-600" />
                    <span class="ml-2 text-sm text-gray-600">Name: A-Z</span>
                  </label>
                  <label class="flex items-center">
                    <input type="radio" name="sort" value="rating-desc" <%=query.sort==='rating-desc' ? 'checked' : ''
                      %>
                    class="h-4 w-4 accent-blue-600" />
                    <span class="ml-2 text-sm text-gray-600">Best Rated</span>
                  </label>
                </div>
              </details>
              <!-- Buttons -->
              <div class="flex gap-4 mt-4">
                <button type="submit"
                  class="flex-1 bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 flex items-center justify-center transition-colors">
                  <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                      d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                  </svg>
                  Apply Filters
                </button>
                <button type="button" id="clear-filters"
                  class="flex-1 bg-gray-200 text-gray-700 py-3 rounded-lg hover:bg-gray-300 flex items-center justify-center transition-colors">
                  Clear Filters
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Products -->
        <div class="flex-1 order-last md:order-last">
          <h1 class="text-3xl font-bold text-gray-800 mb-6 flex items-center">
            <svg class="w-8 h-8 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 6a2 2 0 012-2h2a2 2 0 012 2m-6 6a2 2 0 012-2h2a2 2 0 012 2m-6 6a2 2 0 012-2h2a2 2 0 012 2m2-12h2a2 2 0 012 2m-6 6a2 2 0 012-2h2a2 2 0 012 2m-6 6a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Products
          </h1>
          <% if (typeof error !=='undefined' && error) { %>
            <p class="text-red-500 text-sm flex items-center mb-6">
              <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <%= error %>
            </p>
            <% } %>
              <% if (products.length===0) { %>
                <div class="text-center py-16">
                  <p class="text-gray-500 text-lg">No products found.</p>
                  <a href="/"
                    class="mt-4 inline-block bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700">Browse All
                    Products</a>
                </div>
                <% } else { %>
                  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    <% products.forEach(product=> { %>
                      <div
                        class="bg-white shadow-lg rounded-lg overflow-hidden hover:shadow-xl transition-all duration-300 border border-gray-100">
                        <div class="relative bg-gray-200">
                          <% if (product.thumbnail) { %>
                            <a href="/product/<%= product.id %>">
                              <img src="<%= product.thumbnail.url %>" alt="<%= product.name %>"
                                class="w-full h-64 object-contain transition-transform duration-300 hover:scale-105" />
                            </a>
                            <% if (product.discountPrice && product.discountPrice <=product.price &&
                              (!product.discountExpiry || new Date(product.discountExpiry)> new Date())) { %>
                              <span
                                class="absolute top-3 left-3 bg-red-500 text-white text-sm font-semibold px-3 py-1 rounded-full">
                                -<%= (((product.price - product.discountPrice) / product.price) * 100).toFixed(0) %>%
                              </span>
                              <% } %>
                                <% } %>
                        </div>
                        <div class="p-6">
                          <a href="/product/<%= product.id %>">
                            <h2 class="text-xl font-semibold text-gray-800 line-clamp-2">
                              <%= product.name %>
                            </h2>
                          </a>
                          <p class="text-sm text-gray-600 mt-2">
                            <%= product.category || 'N/A' %>
                          </p>
                          <% if (product.discountPrice && product.discountPrice <=product.price &&
                            (!product.discountExpiry || new Date(product.discountExpiry)> new Date())) { %>
                            <div class="flex items-center gap-3 mt-3">
                              <span class="text-xl font-bold text-blue-600">$<%= product.discountPrice.toFixed(2) %>
                                  </span>
                              <span class="text-sm text-gray-500 line-through">$<%= product.price.toFixed(2) %></span>
                            </div>
                            <p class="text-xs text-gray-500 mt-2">Offer ends <%= new
                                Date(product.discountExpiry).toLocaleDateString() %>
                            </p>
                            <% } else { %>
                              <p class="text-xl font-bold text-blue-600 mt-3">$<%= product.price.toFixed(2) %>
                              </p>
                              <% } %>
                                <!-- Reviews -->
                                <div class="mt-3 flex items-center">
                                  <% let avgRating=product.reviews && product.reviews.length> 0 ?
                                    (product.reviews.reduce((sum, r) => sum + r.rating, 0) /
                                    product.reviews.length).toFixed(1) : 0; %>
                                    <% for (let i=1; i <=5; i++) { %>
                                      <svg
                                        class="w-5 h-5 <%= i <= Math.floor(avgRating) ? 'text-yellow-400' : 'text-gray-300' %>"
                                        fill="currentColor" viewBox="0 0 20 20">
                                        <path
                                          d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.286 3.97a1 1 0 00.95.69h4.162c.969 0 1.371 1.24.588 1.81l-3.365 2.447a1 1 0 00-.364 1.118l1.287 3.971c.3.921-.755 1.688-1.54 1.118l-3.365-2.447a1 1 0 00-1.175 0l-3.365 2.447c-.784.57-1.838-.197-1.54-1.118l1.287-3.971a1 1 0 00-.364-1.118L2.312 9.397c-.783-.57-.38-1.81.588-1.81h4.162a1 1 0 00.95-.69l1.286-3.97z" />
                                      </svg>
                                      <% } %>
                                        <span class="ml-2 text-sm text-gray-600">(<%= product.reviews ?
                                            product.reviews.length : 0 %>)</span>
                                </div>
                                <div class="mt-4 flex gap-3">
                                  <a href="/product/<%= product.id %>"
                                    class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                                    <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                    </svg>
                                    View Details
                                  </a>
                                  <% if (user) { %>
                                    <form action="/cart/add" method="POST">
                                      <input type="hidden" name="productId" value="<%= product.id %>" />
                                      <button type="submit"
                                        class="text-blue-600 hover:text-blue-700 text-sm font-medium flex items-center">
                                        <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                        </svg>
                                        Add to Cart
                                      </button>
                                    </form>
                                    <% } %>
                                </div>
                        </div>
                      </div>
                      <% }) %>
                  </div>
                  <% } %>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Animation for Mobile Filter Toggle */
    .animate-slide-in {
      animation: slideIn 0.3s ease-in-out;
    }

    @keyframes slideIn {
      from {
        transform: translateY(-20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Smooth Transition for Categories */
    #more-categories {
      transition: max-height 0.3s ease, opacity 0.3s ease;
      max-height: 0;
      opacity: 0;
      overflow: hidden;
    }

    #more-categories:not(.hidden) {
      max-height: 500px;
      /* Adjust based on content */
      opacity: 1;
    }
  </style>

  <script>
    // Mobile filter toggle
    const filterToggle = document.getElementById('filter-toggle');
    if (filterToggle) {
      filterToggle.addEventListener('click', () => {
        const form = document.getElementById('filter-form');
        form.classList.toggle('hidden');
        form.classList.toggle('animate-slide-in');
      });
    }

    // Show More Categories
    const showMoreButton = document.getElementById('show-more-categories');
    if (showMoreButton) {
      showMoreButton.addEventListener('click', () => {
        const moreCategories = document.getElementById('more-categories');
        if (moreCategories) {
          const isHidden = moreCategories.classList.contains('hidden');
          moreCategories.classList.toggle('hidden');
          showMoreButton.textContent = isHidden ? 'Show Less' : 'Show More';
          showMoreButton.setAttribute('aria-expanded', isHidden ? 'true' : 'false');
        }
      });
    }

    // Ensure only one category checkbox is selected
    const filterForm = document.getElementById('filter-form');
    document.querySelectorAll('input[name="category"]').forEach(input => {
      input.addEventListener('change', () => {
        if (input.checked) {
          document.querySelectorAll('input[name="category"]').forEach(other => {
            if (other !== input) other.checked = false;
          });
          filterForm.submit();
        }
      });
    });

    // Sort radio buttons
    document.querySelectorAll('input[name="sort"]').forEach(input => {
      input.addEventListener('change', () => {
        filterForm.submit();
      });
    });

    // Clear Filters
    const clearFiltersButton = document.getElementById('clear-filters');
    if (clearFiltersButton) {
      clearFiltersButton.addEventListener('click', () => {
        document.querySelectorAll('input[name="category"]').forEach(input => input.checked = false);
        document.getElementById('category-all').checked = true;
        document.querySelectorAll('input[name="sort"]').forEach(input => input.checked = false);
        document.querySelector('input[name="sort"][value=""]').checked = true;
        filterForm.submit();
      });
    }
  </script>

  <%- include('partials/footer') %>